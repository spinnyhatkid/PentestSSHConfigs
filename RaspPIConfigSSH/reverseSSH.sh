#!/bin/bash

apt-get install autossh whois dnsutils -y
wget https://github.com/spinnyhatkid/ReverseSSHClientFiles/archive/master.zip
unzip master.zip
mkdir -p ~/.ssh
mv -t ~/.ssh ReverseSSHClientFiles-master/*
rm -r *master*
chmod 700 ~/.ssh
chmod 600 ~/.ssh/*

echo "alias ec2SSH='ssh -fNR'" >> ~/.bashrc
echo "alias ec2AutoSSH='autossh -M 0 -fNR'" >> ~/.bashrc

sed -i -e 's/#AuthorizedKeysFile/AuthorizedKeysFile/g' /etc/ssh/sshd_config
sed -i -e 's/#PasswordAuthentication yes/PasswordAuthentication yes/g' /etc/ssh/sshd_config
echo 'GatewayPorts yes' >> /etc/ssh/sshd_config

cp ~/.ssh/authorized_keys ~/.ssh/known_hosts

sed -i -e 's/connections only/connections only\nlocal\tall\t\tmsf3\t\t\t\t\tpassword/' /etc/postgresql/9.5/main/pg_hba.conf
sed -i -e 's/4 local connections:/4 local connections:\nhost\tall\t\tmsf3\t\t0.0.0.0\/0\t\tpassword/' /etc/postgresql/9.5/main/pg_hba.conf
update-rc.d postgresql enable

mv startup.py /etc/
sed -i 's/^exit 0/python2 \/etc\/startup.py\n\nexit 0/' /etc/rc.local

reboot now
