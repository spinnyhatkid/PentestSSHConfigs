#!/usr/bin/python2

import subprocess

#Static IP of Host
serverIP = '54.165.250.145' 

#Run bash commands
def bash_call(cmd):
    return subprocess.call(['/bin/bash', '-c', cmd])

def bash_command(cmd):
    return subprocess.check_output(['/bin/bash', '-c', cmd])

#Convert netmask to CIDR
def get_net_size(netmask):
    binary = ''
    for octet in netmask:
        binary += bin(int(octet))[2:].zfill(8)
    return str(len(binary.rstrip('0')))

#Obtain IP and Netmask of running device
while True:
    ip = bash_command("ifconfig eth0 | grep 'inet ' | awk '{ print $2 }'").rstrip('\n')
	#ip = bash_command("ifconfig eth0 | grep 'inet addr:' | cut -d: -f2 | awk '{ print $1}'").rstrip('\n')
    if ip != "":
        break
netmask = bash_command("ifconfig eth0 | grep netmask | awk '{ print $4 }'").split('.')
#netmask = bash_command("ifconfig eth0 | grep Mask: | cut -d: -f4").split('.')

addr = '%s/%s' % (ip, get_net_size(netmask))

#Determine allowed SSH connections and establish connection to remote apache server
ports = map(str, range(29000,30000))
while True:
    str = bash_command("ssh %s 'netstat -l' | grep %s | wc -c" % (serverIP, ports[0]))
    if str.rstrip('\n') == "0":
        bash_call("ssh -o ConnectTimeout=2 -fNR %s:localhost:5432 %s" % (ports[0], serverIP))
        break
    ports.pop(0)
    if len(ports) == 0:
        break

#Run scan
#bash_call("msfconsole -x 'db_nmap %s -A'" % (addr))

'''
Starting openvas for later use
Only enable when needed
'''
#bash_command("redis-server /etc/redis/redis.conf")
#bash_command("openvassd")
#bash_command("openvasmd")
#bash_command("gsad --http-only -p 9392")
